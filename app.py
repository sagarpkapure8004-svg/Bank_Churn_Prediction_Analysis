import streamlit as st
import pandas as pd
import joblib

# --- 1. Load Model and Feature Names ---
model_filename = 'random_forest_model.pkl'
x_encoded_columns_filename = 'X_encoded_columns.pkl'

model = joblib.load('random_forest_model_compressed.pkl')
loaded_X_encoded_columns = joblib.load(x_encoded_columns_filename)

# --- 2. Streamlit UI Setup ---
st.set_page_config(layout='wide') # Optional: use wide layout
st.title('Customer Churn Prediction App')
st.write('Enter customer details to predict if they will churn (exit the bank).')

st.sidebar.header('Customer Input Features')

# --- 3. Get Unique Values for Categorical Features (from original X) ---
# These are hardcoded from the `X` DataFrame inspection as done during development
# Scaled Score values
scaled_score_values = [
    '(0.34)', '1.22', '(0.70)', '(0.49)', '0.03', '(1.20)', '(0.16)', '1.14',
    '(0.06)', '1.49', '0.67', '0.57', '(0.95)', '(0.89)', '0.34', '0.60',
    '(0.66)', '1.29', '0.97', '(0.09)', '0.74', '1.09', '(0.81)', '0.90',
    '(0.56)', '0.22', '0.12', '(0.23)', '(0.62)', '0.52', '1.01', '(0.02)',
    '(0.25)', '0.07', '0.16', '0.94', '0.78', '(0.77)', '0.40', '(1.04)',
    '0.45', '(0.31)', '0.49', '(0.18)', '0.36', '(0.13)', '0.29', '1.34',
    '1.64', '0.86', '0.82', '1.19', '1.59', '1.74', '(0.45)', '0.69', '1.17',
    '(0.85)', '0.62', '1.79', '1.32', '1.42', '(0.39)', '(0.58)', '0.25',
    '0.99', '1.54', '0.42', '1.07', '1.27', '(0.99)', '0.71', '1.37', '0.80',
    '1.69', '1.89', '1.99', '(1.10)', '1.04', '1.94', '(1.15)', '(1.24)',
    '0.20', '0.92', '1.44', '0.05', '1.84', '0.76', '0.47', '0.65', '0.84',
    '0.55', '0.31', '1.62', '1.06', '(0.01)', '0.38', '1.57', '1.12', '1.39',
    '0.14', '0.64', '1.72', '(0.72)', '1.02', '(1.07)', '0.09', '1.47', '0.50',
    '1.92', '1.24', '1.10', '(0.42)', '0.95', '1.77', '1.87', '(0.04)', '0.73',
    '(0.53)', '0.27', '0.68', '(0.92)', '0.18', '0.61', '0.33', '1.31', '0.24',
    '1.52', '0.44', '1.15', '0.96', '(0.11)', '0.79', '0.59', '0.88', '1.25',
    '0.19', '1.20', '0.37', '1.00', '1.50', '(0.51)', '(0.28)', '1.67', '0.54',
    '1.30', '1.18', '(0.79)', '0.11', '(0.37)', '(0.19)', '(0.90)', '0.00',
    '(0.96)', '(0.41)', '0.70', '1.55', '(0.10)', '(0.08)', '1.05', '0.48',
    '0.08', '(0.35)', '0.28', '1.26', '0.53', '(0.86)', '(0.59)', '(0.63)',
    '1.45', '1.21', '0.66', '1.35', '(0.22)', '1.40', '(0.27)', '0.83', '1.08',
    '0.72', '0.01', '0.63', '(0.03)', '(0.67)', '0.26', '0.98', '0.91', '(0.68)',
    '1.70', '0.39', '0.21', '(0.48)', '1.36', '(0.30)', '0.87', '0.93', '0.10',
    '1.03', '(0.21)', '(0.69)', '1.16', '1.41', '(0.38)', '0.75', '0.85', '(0.15)',
    '1.56', '1.28', '0.32', '1.65', '1.75', '1.90', '0.46', '(0.80)', '1.11',
    '1.80', '1.38', '1.48', '0.77', '0.04', '0.79', '0.15', '1.13', '0.51',
    '1.60', '1.66', '1.71', '1.81', '1.91', '1.96', '1.98', '0.60', '0.90',
    '1.20', '1.50', '(0.30)', '0.30', '0.60', '0.90', '1.20', '1.50', '1.80',
    '2.10', '(0.60)', '(0.90)', '(1.20)', '(1.50)', '(1.80)', '(2.10)', '0.00',
    '0.30', '0.60', '0.90', '1.20', '1.50', '1.80', '2.10', '(0.00)', '(0.30)',
    '(0.60)', '(0.90)', '(1.20)', '(1.50)', '(1.80)', '(2.10)'
]

scaled_age_values = [
    '0.87', '0.29', '1.44', '2.01', '1.06', '0.97', '0.78', '0.58', '1.35',
    '1.63', '0.68', '1.25', '1.73', '0.49', '0.39', '1.16', '1.54', '0.87',
    '0.09', '0.19', '0.78', '1.25', '0.39', '0.58', '0.09', '0.68', '1.06',
    '1.44', '1.82', '0.19', '0.29', '0.49', '0.58', '0.78', '0.97', '1.16',
    '1.35', '1.54', '1.73', '1.92', '2.01', '0.00', '0.20', '0.40', '0.60',
    '0.80', '1.00', '1.20', '1.40', '1.60', '1.80', '2.00', '2.20', '2.40',
    '2.60', '2.80', '3.00', '3.20', '3.40', '3.60', '3.80', '4.00'
]

scaled_tenure_values = [
    '1.56', '0.52', '0.00', '1.04', '2.08', '2.60', '0.78', '1.82', '0.26',
    '1.30', '0.00', '0.20', '0.40', '0.60', '0.80', '1.00', '1.20', '1.40',
    '1.60', '1.80', '2.00', '2.20', '2.40', '2.60', '2.80', '3.00', '3.20'
]

scaled_balance_values = [
    '£0.00', '£115,988.86', '£91,611.12', '£122,817.84', '£134,603.20',
    '£108,300.45', '£100,642.87', '£100,904.38', '£94,842.11', '£75,542.59',
    '£100,163.63', '£109,240.23', '£130,233.02', '£121,228.61', '£106,128.84',
    '£113,446.40', '£123,941.34', '£104,780.70', '£140,891.30', '£118,527.18',
    '£88,340.56', '£101,006.59', '£101,234.34', '£124,337.00', '£131,400.99',
    '£108,609.11', '£105,747.01', '£111,213.97', '£122,787.05', '£141,610.15',
    '£95,191.07', '£123,086.72', '£116,677.30', '£113,103.32', '£109,796.81',
    '£137,845.89', '£148,072.18', '£116,211.75', '£104,505.74', '£115,081.71',
    '£105,372.43', '£118,054.40', '£114,813.10', '£108,946.06', '£113,293.77',
    '£117,143.91', '£106,750.81', '£131,349.52', '£99,997.71', '£100,535.19',
    '£106,183.15', '£116,252.61', '£106,629.74', '£108,245.96', '£96,564.25',
    '£102,642.06', '£124,191.24', '£120,404.91', '£105,257.06', '£99,636.52',
    '£121,553.47', '£120,019.29', '£109,472.04', '£127,147.23', '£107,433.00',
    '£109,726.54', '£98,735.68', '£111,102.72', '£110,697.10', '£136,547.09',
    '£132,965.73', '£113,212.74', '£108,799.37', '£128,786.13', '£124,960.29',
    '£133,021.91', '£106,478.71', '£106,423.46', '£110,131.60', '£103,429.62',
    '£120,950.59', '£101,281.33', '£107,364.55', '£108,236.43', '£123,022.04',
    '£120,622.75', '£109,003.82', '£105,627.46', '£107,678.96', '£125,725.69',
    '£106,000.52', '£124,756.91', '£131,691.07', '£132,604.28', '£109,363.30',
    '£122,058.62', '£118,552.01', '£130,171.18', '£98,771.69', '£99,228.32',
    '£114,142.19', '£106,488.24', '£122,781.11', '£119,742.86', '£110,956.12',
    '£104,749.69', '£121,080.37', '£128,198.88', '£105,820.58', '£101,847.45',
    '£104,028.16', '£117,143.68', '£115,224.23', '£130,580.41', '£112,246.33',
    '£112,657.48', '£118,126.79', '£105,302.39', '£115,532.74', '£107,088.39',
    '£107,052.88', '£113,874.52', '£109,471.21', '£110,480.08', '£102,784.81',
    '£128,495.84', '£116,916.10', '£114,845.09', '£110,317.81', '£106,177.36',
    '£117,994.49', '£106,589.65', '£121,059.60', '£102,042.89', '£103,117.81',
    '£104,409.81', '£107,314.93', '£113,674.32', '£106,739.06', '£104,220.10',
    '£115,860.97', '£120,400.99', '£113,222.18', '£108,829.41', '£110,757.45',
    '£109,879.79', '£102,576.49', '£103,989.87', '£112,987.58', '£106,861.43',
    '£115,148.06', '£113,991.68', '£108,187.73', '£108,235.19', '£110,782.38',
    '£114,561.35', '£107,597.51', '£117,458.07', '£104,505.74', '£115,081.71',
    '£105,372.43', '£118,054.40', '£114,813.10', '£108,946.06', '£113,293.77',
    '£117,143.91', '£106,750.81', '£131,349.52', '£99,997.71', '£100,535.19',
    '£106,183.15', '£116,252.61', '£106,629.74', '£108,245.96', '£96,564.25',
    '£102,642.06', '£124,191.24', '£120,404.91', '£105,257.06', '£99,636.52',
    '£121,553.47', '£120,019.29', '£109,472.04', '£127,147.23', '£107,433.00',
    '£109,726.54', '£98,735.68', '£111,102.72', '£110,697.10', '£136,547.09',
    '£132,965.73', '£113,212.74', '£108,799.37', '£128,786.13', '£124,960.29',
    '£133,021.91', '£106,478.71', '£106,423.46', '£110,131.60', '£103,429.62',
    '£120,950.59', '£101,281.33', '£107,364.55', '£108,236.43', '£123,022.04',
    '£120,622.75', '£109,003.82', '£105,627.46', '£107,678.96', '£125,725.69',
    '£106,000.52', '£124,756.91', '£131,691.07', '£132,604.28', '£109,363.30',
    '£122,058.62', '£118,552.01', '£130,171.18', '£98,771.69', '£99,228.32',
    '£114,142.19', '£106,488.24', '£122,781.11', '£119,742.86', '£110,956.12',
    '£104,749.69', '£121,080.37', '£128,198.88', '£105,820.58', '£101,847.45',
    '£104,028.16', '£117,143.68', '£115,224.23', '£130,580.41', '£112,246.33',
    '£112,657.48', '£118,126.79', '£105,302.39', '£115,532.74', '£107,088.39',
    '£107,052.88', '£113,874.52', '£109,471.21', '£110,480.08', '£102,784.81',
    '£128,495.84', '£116,916.10', '£114,845.09', '£110,317.81', '£106,177.36',
    '£117,994.49', '£106,589.65', '£121,059.60', '£102,042.89', '£103,117.81',
    '£104,409.81', '£107,314.93', '£113,674.32', '£106,739.06', '£104,220.10',
    '£115,860.97', '£120,400.99', '£113,222.18', '£108,829.41', '£110,757.45',
    '£109,879.79', '£102,576.49', '£103,989.87', '£112,987.58', '£106,861.43',
    '£115,148.06', '£113,991.68', '£108,187.73', '£108,235.19', '£110,782.38',
    '£114,561.35', '£107,597.51', '£117,458.07'
]

balance_to_salary_ratio_values = [
    '£0.00', '£1.45', '£1.10', '£1.15', '£0.98', '£1.07', '£0.87', '£1.00',
    '£0.89', '£0.96', '£0.70', '£1.20', '£0.92', '£1.16', '£1.30', '£1.03',
    '£1.33', '£0.85', '£1.08', '£0.66', '£1.13', '£0.82', '£1.40', '£1.25',
    '£0.95', '£1.02', '£0.78', '£0.67', '£0.90', '£0.77', '£0.50', '£0.60',
    '£0.40', '£0.20', '£0.10', '£0.00', '£1.50', '£1.60', '£1.70', '£1.80',
    '£1.90', '£2.00', '£2.10', '£2.20', '£2.30', '£2.40', '£2.50', '£2.60',
    '£2.70', '£2.80', '£2.90', '£3.00', '£3.10', '£3.20', '£3.30', '£3.40',
    '£3.50', '£3.60', '£3.70', '£3.80', '£3.90', '£4.00'
]

engagement_score_values = [
    '(1.00)', '0.00', '(0.50)', '0.50', '1.00', '(1.50)', '1.50', '(2.00)',
    '2.00', '(2.50)', '2.50', '(3.00)', '3.00', '(3.50)', '3.50', '(4.00)',
    '4.00', '(4.50)', '4.50', '(5.00)', '5.00', '(5.50)', '5.50', '(6.00)',
    '6.00', '(6.50)', '6.50', '(7.00)', '7.00', '(7.50)', '7.50', '(8.00)',
    '8.00', '(8.50)', '8.50', '(9.00)', '9.00', '(9.50)', '9.50', '(10.00)',
    '10.00'
]

scaled_salary_values = [
    '£10,000.00', '£11,000.00', '£12,000.00', '£13,000.00', '£14,000.00',
    '£15,000.00', '£16,000.00', '£17,000.00', '£18,000.00', '£19,000.00',
    '£20,000.00', '£21,000.00', '£22,000.00', '£23,000.00', '£24,000.00',
    '£25,000.00', '£26,000.00', '£27,000.00', '£28,000.00', '£29,000.00',
    '£30,000.00', '£31,000.00', '£32,000.00', '£33,000.00', '£34,000.00',
    '£35,000.00', '£36,000.00', '£37,000.00', '£38,000.00', '£39,000.00',
    '£40,000.00', '£41,000.00', '£42,000.00', '£43,000.00', '£44,000.00',
    '£45,000.00', '£46,000.00', '£47,000.00', '£48,000.00', '£49,000.00',
    '£50,000.00', '£51,000.00', '£52,000.00', '£53,000.00', '£54,000.00',
    '£55,000.00', '£56,000.00', '£57,000.00', '£58,000.00', '£59,000.00',
    '£60,000.00', '£61,000.00', '£62,000.00', '£63,000.00', '£64,000.00',
    '£65,000.00', '£66,000.00', '£67,000.00', '£68,000.00', '£69,000.00',
    '£70,000.00', '£71,000.00', '£72,000.00', '£73,000.00', '£74,000.00',
    '£75,000.00', '£76,000.00', '£77,000.00', '£78,000.00', '£79,000.00',
    '£80,000.00', '£81,000.00', '£82,000.00', '£83,000.00', '£84,000.00',
    '£85,000.00', '£86,000.00', '£87,000.00', '£88,000.00', '£89,000.00',
    '£90,000.00', '£91,000.00', '£92,000.00', '£93,000.00', '£94,000.00',
    '£95,000.00', '£96,000.00', '£97,000.00', '£98,000.00', '£99,000.00',
    '£100,000.00', '£101,000.00', '£102,000.00', '£103,000.00', '£104,000.00',
    '£105,000.00', '£106,000.00', '£107,000.00', '£108,000.00', '£109,000.00',
    '£110,000.00', '£111,000.00', '£112,000.00', '£113,000.00', '£114,000.00',
    '£115,000.00', '£116,000.00', '£117,000.00', '£118,000.00', '£119,000.00',
    '£120,000.00', '£121,000.00', '£122,000.00', '£123,000.00', '£124,000.00',
    '£125,000.00', '£126,000.00', '£127,000.00', '£128,000.00', '£129,000.00',
    '£130,000.00', '£131,000.00', '£132,000.00', '£133,000.00', '£134,000.00',
    '£135,000.00', '£136,000.00', '£137,000.00', '£138,000.00', '£139,000.00',
    '£140,000.00', '£141,000.00', '£142,000.00', '£143,000.00', '£144,000.00',
    '£145,000.00', '£146,000.00', '£147,000.00', '£148,000.00', '£149,000.00',
    '£150,000.00', '£151,000.00', '£152,000.00', '£153,000.00', '£154,000.00',
    '£155,000.00', '£156,000.00', '£157,000.00', '£158,000.00', '£159,000.00',
    '£160,000.00', '£161,000.00', '£162,000.00', '£163,000.00', '£164,000.00',
    '£165,000.00', '£166,000.00', '£167,000.00', '£168,000.00', '£169,000.00',
    '£170,000.00', '£171,000.00', '£172,000.00', '£173,000.00', '£174,000.00',
    '£175,000.00', '£176,000.00', '£177,000.00', '£178,000.00', '£179,000.00',
    '£180,000.00', '£181,000.00', '£182,000.00', '£183,000.00', '£184,000.00',
    '£185,000.00', '£186,000.00', '£187,000.00', '£188,000.00', '£189,000.00',
    '£190,000.00', '£191,000.00', '£192,000.00', '£193,000.00', '£194,000.00',
    '£195,000.00', '£196,000.00', '£197,000.00', '£198,000.00', '£199,000.00',
    '£200,000.00'
]


# --- 4. User Input Widgets ---
# Numerical features
france = st.sidebar.number_input('France (1=Yes, 0=No)', 0, 1, 0)
spain = st.sidebar.number_input('Spain (1=Yes, 0=No)', 0, 1, 0)
male = st.sidebar.number_input('Male (1=Yes, 0=No)', 0, 1, 0)
num_of_products = st.sidebar.number_input('Number of Products', 1, 4, 1)
product_to_tenure_ratio = st.sidebar.number_input('Product to Tenure Ratio', 0.0, 5.0, 0.5, format="%.2f")
age_tenure = st.sidebar.number_input('Age Tenure', 0.0, 200.0, 30.0, format="%.2f")

# Categorical features
scaled_score = st.sidebar.selectbox('Scaled Score', scaled_score_values)
scaled_age = st.sidebar.selectbox('Scaled Age', scaled_age_values)
scaled_tenure = st.sidebar.selectbox('Scaled Tenure', scaled_tenure_values)
scaled_balance = st.sidebar.selectbox('Scaled Balance', scaled_balance_values)
balance_to_salary_ratio = st.sidebar.selectbox('Balance to Salary Ratio', balance_to_salary_ratio_values)
engagement_score = st.sidebar.selectbox('Engagement Score', engagement_score_values)
scaled_salary = st.sidebar.selectbox('Scaled Salary', scaled_salary_values)


# --- 5. Data Preprocessing ---
def preprocess_input(input_data):
    # Convert input to DataFrame
    input_df = pd.DataFrame([input_data])

    # Define original categorical columns (matching how X was processed)
    categorical_cols_original = [
        'Scaled Score', 'Scaled Age', 'Scaled Tenure', 'Scaled Balance',
        'Balance to Salary Ratio', 'Engagement Score', 'Scaled Salary'
    ]

    # Apply one-hot encoding
    input_df_encoded = pd.get_dummies(input_df, columns=categorical_cols_original, drop_first=True)

    # Align columns with the training data's encoded columns
    # Create a DataFrame with all expected columns and fill with 0
    final_input = pd.DataFrame(0, index=[0], columns=loaded_X_encoded_columns)

    # Fill in the values from the user's encoded input
    for col in input_df_encoded.columns:
        if col in final_input.columns:
            final_input[col] = input_df_encoded[col]
    
    return final_input

# --- 6. Prediction and Display ---
if st.sidebar.button('Predict'):
    user_input = {
        'France': france,
        'Spain': spain,
        'Male': male,
        'NumOfProducts': num_of_products,
        'Product to tenure Ratio': product_to_tenure_ratio,
        'Age Tenure': age_tenure,
        'Scaled Score': scaled_score,
        'Scaled Age': scaled_age,
        'Scaled Tenure': scaled_tenure,
        'Scaled Balance': scaled_balance,
        'Balance to Salary Ratio': balance_to_salary_ratio,
        'Engagement Score': engagement_score,
        'Scaled Salary': scaled_salary
    }

    processed_input = preprocess_input(user_input)
    prediction = model.predict(processed_input)

    st.subheader('Prediction Result:')
    if prediction[0] == 0:
        st.success('The customer is predicted to STAY.')
    else:
        st.error('The customer is predicted to EXIT.')

print("Created app.py successfully!")
